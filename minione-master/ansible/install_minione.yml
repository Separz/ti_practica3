---
- name: Instalar Minione
  hosts: minone
  become: true
  gather_facts: no
  tasks:
    - name: Asegurar entrada en /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^\S+\s+minione\.midominio\.org\s+minione'
        line: '{{ ansible_host }} minione.midominio.org minione'
        state: present

    - name: Descargar Minione usando wget (forzado)
      ansible.builtin.command: >
        wget -O /tmp/minione 'https://github.com/OpenNebula/minione/releases/latest/download/minione'
      args:
        creates: /tmp/minione 

    - name: Añadir permisos de ejecución al script
      ansible.builtin.file:
        path: /tmp/minione
        mode: '0755'

    - name: Ejecutar instalador Minione y capturar salida
      ansible.builtin.shell: |
        echo yes | bash /tmp/minione 2>&1
      args:
        executable: /bin/bash
      register: minione_install

    - name: Mostrar salida de la instalación
      ansible.builtin.debug:
        var: minione_install.stdout_lines

    - name: Obtener contraseña de oneadmin desde archivo
      ansible.builtin.command: cat /var/lib/one/.one/one_auth
      register: one_auth_file

    - name: Extraer contraseña
      set_fact:
        oneadmin_password: "{{ one_auth_file.stdout.split(':')[1] }}"

    - name: Guardar credenciales en archivo local one_auth
      local_action:
        module: copy
        content: "{{ one_auth_file.stdout }}"
        dest: "../terraform/vms/one_auth"
      become: no

    - name: Mostrar contraseña capturada
      ansible.builtin.debug:
        msg: "Contraseña de oneadmin capturada: {{ oneadmin_password }}"